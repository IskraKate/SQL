IF DB_ID('FootballChampionship') IS NOT NULL
BEGIN
	USE master
		 ALTER DATABASE FootballChampionship SET single_user with rollback immediate
    DROP DATABASE FootballChampionship
END
GO 

CREATE DATABASE FootballChampionship
GO

USE FootballChampionship
Go

CREATE TABLE Positions
(
	Id int PRIMARY KEY IDENTITY,
	[Name] NVARCHAR(100) NOT NULL
)
GO

CREATE TABLE Equipment
(
	Id int PRIMARY KEY IDENTITY,
	[Name] NVARCHAR(100) NOT NULL
)
GO


CREATE TABLE Countries
(
	Id int PRIMARY KEY IDENTITY,
	[Name] NVARCHAR(100) NOT NULL
)
GO

CREATE TABLE Trainers
(
	Id int PRIMARY KEY IDENTITY,
	[Name] NVARCHAR(100) NOT NULL,
	CountryFk int,
	CountryChampFk int,

	FOREIGN KEY (CountryFk) REFERENCES Countries(Id),
	FOREIGN KEY (CountryChampFk) REFERENCES Countries(Id)
)
GO

CREATE TABLE Cities
(
	Id int PRIMARY KEY IDENTITY,
	[Name] NVARCHAR(100) NOT NULL,
	CountryFk int

	FOREIGN KEY (CountryFk) REFERENCES Countries(Id)
	ON DELETE CASCADE
	ON UPDATE CASCADE
)
GO

CREATE TABLE Stadiums
(
	Id int PRIMARY KEY IDENTITY,
	[Name] NVARCHAR(100) NOT NULL,
	Capacity int,
	CityFk int

	FOREIGN KEY (CityFk) REFERENCES Cities(Id)
	ON DELETE CASCADE
	ON UPDATE CASCADE
)
GO

CREATE TABLE Commands
(	
	Id int PRIMARY KEY IDENTITY,
	[Name] NVARCHAR(100) NOT NULL,
	CountryFk int NOT NULL,
	TrainerFk int NOT NULL,
	EquipmentFk int NOT NULL

	FOREIGN KEY (CountryFk) REFERENCES Countries(Id)
	ON DELETE CASCADE
	ON UPDATE CASCADE,
	FOREIGN KEY (TrainerFk) REFERENCES Trainers(Id)
	ON DELETE CASCADE
	ON UPDATE CASCADE,
	FOREIGN KEY (EquipmentFk) REFERENCES Equipment(Id)
	ON DELETE CASCADE
	ON UPDATE CASCADE
)
Go

CREATE TABLE Players
(
	Id int PRIMARY KEY NOT NULL,
	[Name] NVARCHAR(100) NOT NULL,
	CommandFk int NOT NULL

	FOREIGN KEY (CommandFk) REFERENCES Commands(Id)
	ON DELETE CASCADE
	ON UPDATE CASCADE,
	FOREIGN KEY (Id) REFERENCES Positions(Id)
	ON DELETE CASCADE
	ON UPDATE CASCADE
)
GO

CREATE TABLE Associations
(
	Id int PRIMARY KEY NOT NULL,
	[Name] NVARCHAR(100) NOT NULL
)
Go

CREATE TABLE Judges
(
	Id int PRIMARY KEY NOT NULL,
	[Name] NVARCHAR(100) NOT NULL,
	AssociationFk int NOT NULL

	FOREIGN KEY (AssociationFk) REFERENCES Associations(Id)
	ON DELETE CASCADE
	ON UPDATE CASCADE
)
Go

CREATE TABLE Matches
(
	Id INT PRIMARY KEY NOT NULL,
	Schedule DATETIME NOT NULL,
	CommandFk1 INT NOT NULL,
	CommandFk2 INT NOT NULL,
	JudgeFk INT NOT NULL,
	StadiumFk INT NOT NULL,

	FOREIGN KEY (JudgeFk) REFERENCES Judges(Id)
	ON DELETE CASCADE
	ON UPDATE CASCADE,
	FOREIGN KEY (StadiumFk) REFERENCES Stadiums(Id)
	ON DELETE NO ACTION
	ON UPDATE NO ACTION,
	FOREIGN KEY (CommandFk1) REFERENCES Commands(Id)
	ON DELETE NO ACTION
	ON UPDATE NO ACTION,
	FOREIGN KEY (CommandFk2) REFERENCES Commands(Id)
	ON DELETE NO ACTION
	ON UPDATE NO ACTION
)
Go

CREATE TABLE MatchResults
(
	Id INT PRIMARY KEY NOT NULL,
	Winner INT NULL,
	Looser INT NULL,
	Result NVARCHAR(100) NOT NULL
	--'Выиграла одна из сторон/Ничья'
	FOREIGN KEY (Id) REFERENCES Matches(Id)
	ON DELETE CASCADE
	ON UPDATE CASCADE
)

CREATE TABLE TopScorers
(
	Id INT PRIMARY KEY NOT NULL,
	TimeIfGoal TIME NOT NULL,
	PlayerFk INT NOT NULL,
	MatchFk INT NOT NULL

	FOREIGN KEY (PlayerFk) REFERENCES Players(Id)
	ON DELETE CASCADE
	ON UPDATE CASCADE,
	FOREIGN KEY(MatchFk) REFERENCES Matches(Id)
	ON DELETE CASCADE
	ON UPDATE CASCADE
)
Go
